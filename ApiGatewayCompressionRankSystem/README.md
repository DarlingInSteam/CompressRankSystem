# API Gateway для системы CompressRankSystem

API Gateway предоставляет единую точку входа для всех клиентов системы CompressRank, работая как маршрутизатор запросов к соответствующим микросервисам.

## Архитектура

API Gateway обеспечивает следующую функциональность:

- **Маршрутизация запросов** - перенаправляет входящие запросы к соответствующим микросервисам
- **Агрегация данных** - объединяет данные из разных микросервисов при необходимости
- **Аутентификация и авторизация** - единая точка для безопасности
- **Кэширование** - улучшает производительность за счет кэширования часто запрашиваемых данных
- **Балансировка нагрузки** - распределяет запросы между экземплярами микросервисов
- **Мониторинг** - отслеживание запросов и контроль состояния системы
- **Документация API** - централизованная документация всех сервисов

## Взаимодействие с микросервисами

API Gateway взаимодействует с двумя основными микросервисами системы:

1. **Image Storage Service (8081)** - управление изображениями
   - API доступно по `/api/images/**`
   
2. **Compression Service (8080)** - сжатие и обработка изображений
   - API доступно по `/api/compression/**`

## Конфигурирование

Основные настройки API Gateway находятся в `application.yml`. Конфигурация включает:

- Базовый порт: `8082`
- Настройки маршрутизации и фильтрации запросов
- Конфигурация отказоустойчивости (circuit breaker, retry)
- Лимитирование запросов и доступа

### Переменные окружения

API Gateway поддерживает следующие переменные окружения:

- `IMAGE_STORAGE_SERVICE_URL` - URL сервиса хранения изображений (по умолчанию: `http://localhost:8081`)
- `COMPRESSION_SERVICE_URL` - URL сервиса сжатия (по умолчанию: `http://localhost:8080`)
- `GATEWAY_URL` - URL шлюза API (по умолчанию: `http://localhost:8082`)

## Начало работы

### Запуск приложения

Для запуска приложения выполните следующие команды:

```bash
# Сборка проекта (из корневой директории проекта)
./gradlew build

# Запуск API Gateway
java -jar build/libs/ApiGatewayCompressionRankSystem-0.0.1-SNAPSHOT.jar
```

### Проверка статуса

Проверить статус системы можно по адресу:

```
GET http://localhost:8082/api/system/health
```

### Документация API

Документация API доступна по адресам:

- OpenAPI UI: `http://localhost:8082/swagger-ui.html`
- OpenAPI спецификация: `http://localhost:8082/v3/api-docs`
- Пользовательская документация API: `http://localhost:8082/api/docs`

## Основные API эндпоинты

### Сервис хранения изображений

- `GET /api/images` - Получение списка всех изображений
- `GET /api/images/{id}` - Получение изображения по ID
- `GET /api/images/{id}/metadata` - Получение метаданных изображения
- `POST /api/images` - Загрузка нового изображения
- `DELETE /api/images/{id}` - Удаление изображения
- `GET /api/images/statistics` - Получение статистики по изображениям
- `GET /api/images/{id}/statistics` - Получение статистики по конкретному изображению

### Сервис сжатия изображений

- `POST /api/compression/{id}` - Сжатие изображения
- `POST /api/compression/{id}/restore` - Восстановление оригинала изображения
- `GET /api/compression/{id}/original-size` - Получение размера оригинального изображения

### API Gateway

- `GET /api/system/health` - Проверка состояния системы
- `GET /api/system/info` - Информация о системе и версиях
- `GET /api/docs` - Документация API
- `GET /api/metrics/aggregated` - Агрегированные метрики по всем сервисам

## Обработка ошибок

API Gateway обеспечивает единый формат ответов с ошибками:

```json
{
  "status": "error",
  "message": "Текст сообщения об ошибке",
  "code": "КОД_ОШИБКИ",
  "timestamp": 1618569930000,
  "path": "/api/images/123"
}
```

## Circuit Breaker и отказоустойчивость

API Gateway использует паттерн Circuit Breaker для обеспечения отказоустойчивости:

- При недоступности сервиса, Circuit Breaker разрывает цепь и перенаправляет на fallback
- Восстановление происходит постепенно с проверкой доступности сервиса
- Настройки параметров Circuit Breaker находятся в `application.yml`

## Docker

Сборка и запуск с помощью Docker:

```bash
# Сборка образа
docker build -t api-gateway .

# Запуск контейнера
docker run -p 8082:8082 \
  -e IMAGE_STORAGE_SERVICE_URL=http://image-storage:8081 \
  -e COMPRESSION_SERVICE_URL=http://compression:8080 \
  api-gateway
```

## Настройка клиента (админ-панели)

Для использования API Gateway в админ-панели необходимо:

1. Обновить URL в `api.config.ts` на URL API Gateway (`http://localhost:8082`)
2. Все запросы с префиксами `/api/images` и `/api/compression` будут автоматически маршрутизироваться к соответствующим сервисам

## Масштабирование и балансировка нагрузки

API Gateway поддерживает несколько экземпляров микросервисов. Для этого можно:

1. Настроить service discovery (например, Consul или Eureka)
2. Использовать контейнеризацию и оркестрацию (Docker, Kubernetes)
3. Настроить балансировку нагрузки для распределения запросов

## Логирование и мониторинг

API Gateway предоставляет:

- Подробные логи запросов и ответов (уровень DEBUG)
- Метрики через Spring Actuator (доступны по `/actuator/metrics`)
- Информацию о состоянии системы (доступна по `/actuator/health`)

## Безопасность

API Gateway обеспечивает:

- CORS настройки для безопасного доступа к API
- Возможность подключения аутентификации и авторизации
- Лимитирование запросов для предотвращения DoS-атак